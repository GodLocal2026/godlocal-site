import { NextResponse } from 'next/server';

const HTML = '<!DOCTYPE html>\n<html lang="ru">\n<head>\n  <meta charset="UTF-8"/>\n  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>\n  <meta name="apple-mobile-web-app-capable" content="yes"/>\n  <meta name="theme-color" content="#0A0C0F"/>\n  <title>GodLocal Voice</title>\n  <style>\n    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}\n    :root{--bg:#0A0C0F;--s:#111316;--b:#1e2127;--g:#00FF9D;--p:#6C5CE7;--t:#E0E0E0;--m:rgba(224,224,224,.45);--d:rgba(224,224,224,.15)}\n    html,body{height:100%;background:var(--bg);color:var(--t);\n      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;\n      overflow:hidden;-webkit-tap-highlight-color:transparent}\n    #app{display:flex;flex-direction:column;height:100%}\n\n    /* HEADER */\n    header{display:flex;align-items:center;justify-content:space-between;\n      padding:12px 16px;border-bottom:1px solid var(--b);\n      background:rgba(10,12,15,.92);backdrop-filter:blur(12px);flex-shrink:0;z-index:10}\n    .logo{display:flex;align-items:center;gap:8px;text-decoration:none;color:var(--t)}\n    .li{width:26px;height:26px;border-radius:6px;background:rgba(0,255,157,.1);\n      border:1px solid rgba(0,255,157,.3);display:flex;align-items:center;justify-content:center;\n      font-family:monospace;font-weight:700;font-size:12px;color:var(--g)}\n    .lt{font-weight:700;font-size:15px}.lt span{color:var(--g)}\n    .hr{display:flex;align-items:center;gap:10px}\n    #dot{width:7px;height:7px;border-radius:50%;background:#444;transition:all .3s}\n    #dot.on{background:var(--g);box-shadow:0 0 6px rgba(0,255,157,.7)}\n    #dot.err{background:#FF6B6B}\n    #sb-btn{background:none;border:none;cursor:pointer;color:var(--m);font-size:17px;padding:4px 6px;line-height:1}\n\n    /* CHAT */\n    #chat{flex:1;overflow-y:auto;padding:12px 14px 4px;display:flex;flex-direction:column;gap:8px}\n    #chat::-webkit-scrollbar{width:2px}\n    #chat::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08)}\n    .msg{display:flex;flex-direction:column;max-width:84%;animation:fu .22s ease}\n    @keyframes fu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}\n    .msg.u{align-self:flex-end;align-items:flex-end}\n    .msg.a{align-self:flex-start;align-items:flex-start}\n    .bbl{padding:9px 13px;border-radius:15px;font-size:14px;line-height:1.55}\n    .msg.u .bbl{background:rgba(0,255,157,.1);border:1px solid rgba(0,255,157,.2);border-bottom-right-radius:3px}\n    .msg.a .bbl{background:var(--s);border:1px solid var(--b);border-bottom-left-radius:3px}\n    .msg.err .bbl{background:rgba(255,107,107,.08);border:1px solid rgba(255,107,107,.25);color:#FF8A8A}\n    .ts{font-size:10px;color:var(--d);margin-top:2px;padding:0 3px;font-family:monospace}\n    .dots{display:inline-flex;gap:4px}\n    .dots span{width:6px;height:6px;border-radius:50%;background:var(--g);opacity:.3;animation:bk 1.2s infinite}\n    .dots span:nth-child(2){animation-delay:.2s}.dots span:nth-child(3){animation-delay:.4s}\n    @keyframes bk{0%,80%,100%{opacity:.2;transform:scale(.9)}40%{opacity:1;transform:scale(1.1)}}\n    #empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;\n      gap:6px;text-align:center}\n    #empty .ei{font-size:42px;opacity:.3;margin-bottom:4px}\n    #empty p{font-size:13px;line-height:1.65;max-width:190px;color:var(--m)}\n    #empty small{font-size:11px;font-family:monospace;color:var(--d)}\n\n    /* LIVE */\n    #live{flex-shrink:0;padding:3px 18px;min-height:22px;font-size:12px;font-style:italic;\n      color:var(--m);opacity:0;transition:opacity .2s}\n    #live.on{opacity:1}\n\n    /* BOTTOM */\n    #bot{flex-shrink:0;padding:10px 14px 22px;border-top:1px solid var(--b);\n      background:linear-gradient(to top,rgba(0,255,157,.03),transparent);\n      display:flex;flex-direction:column;align-items:center;gap:10px}\n    #st{font-size:12px;font-family:monospace;color:var(--m);height:15px;transition:color .2s;text-align:center}\n    #st.ls{color:var(--g)}#st.tk{color:var(--p)}#st.sp{color:#00B4D8}#st.er{color:#FF8A8A}\n\n    /* ORB */\n    #orb{width:66px;height:66px;border-radius:50%;background:var(--s);\n      border:2px solid rgba(0,255,157,.2);display:flex;align-items:center;justify-content:center;\n      cursor:pointer;transition:all .15s;-webkit-user-select:none;user-select:none;\n      touch-action:manipulation;-webkit-tap-highlight-color:rgba(0,255,157,.15);outline:none}\n    #orb:active{transform:scale(.92);background:rgba(0,255,157,.12);border-color:var(--g)}\n    #orb.ls{background:rgba(0,255,157,.1);border-color:var(--g);animation:pulse 1.4s ease-in-out infinite}\n    #orb.tk{background:rgba(108,92,231,.1);border-color:var(--p)}\n    #orb.sp{background:rgba(0,180,216,.1);border-color:#00B4D8}\n    #orb.er{background:rgba(255,107,107,.1);border-color:#FF6B6B}\n    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(0,255,157,.4)}70%{box-shadow:0 0 0 16px rgba(0,255,157,0)}100%{box-shadow:0 0 0 0 rgba(0,255,157,0)}}\n    #oi{font-size:26px;pointer-events:none}\n\n    /* TEXT INPUT */\n    #tr{display:flex;gap:8px;width:100%;max-width:480px}\n    #ti{flex:1;background:var(--s);border:1px solid var(--b);border-radius:20px;\n      color:var(--t);padding:9px 14px;font-size:14px;outline:none;min-width:0}\n    #ti::placeholder{color:var(--d)}\n    #ti:focus{border-color:rgba(0,255,157,.35)}\n    #sb{background:rgba(0,255,157,.1);border:1px solid rgba(0,255,157,.25);border-radius:20px;\n      color:var(--g);padding:9px 14px;font-size:13px;cursor:pointer;\n      transition:background .15s;touch-action:manipulation;white-space:nowrap}\n    #sb:active{background:rgba(0,255,157,.2)}\n\n    /* ACTS */\n    #acts{display:flex;gap:8px}\n    .act{padding:5px 11px;border-radius:16px;font-size:11px;font-family:monospace;\n      border:1px solid var(--b);background:none;color:var(--m);cursor:pointer;\n      transition:all .15s;touch-action:manipulation}\n    .act:active{color:var(--t);border-color:rgba(255,255,255,.2)}\n\n    /* SETTINGS */\n    #sp{position:absolute;inset:0;background:rgba(10,12,15,.97);backdrop-filter:blur(14px);\n      z-index:20;display:flex;flex-direction:column;padding:22px 18px;gap:18px;\n      transform:translateX(100%);transition:transform .26s cubic-bezier(.4,0,.2,1)}\n    #sp.open{transform:translateX(0)}\n    .sph{display:flex;align-items:center;justify-content:space-between}\n    .spt{font-weight:700;font-size:16px}\n    #spc{background:none;border:none;cursor:pointer;color:var(--m);font-size:22px}\n    .sg label{display:block;font-size:11px;font-family:monospace;color:var(--m);\n      text-transform:uppercase;letter-spacing:.08em;margin-bottom:7px}\n    .sg select,.sg input{width:100%;background:var(--s);border:1px solid var(--b);\n      border-radius:10px;color:var(--t);padding:9px 12px;font-size:13px;outline:none;\n      -webkit-appearance:none;appearance:none}\n    .sg select:focus,.sg input[type="text"]:focus{border-color:rgba(0,255,157,.4)}\n    .sn{font-size:12px;color:var(--d);line-height:1.5}\n  </style>\n</head>\n<body>\n<div id="app">\n  <header>\n    <a class="logo" href="/">\n      <div class="li">G</div>\n      <span class="lt">God<span>Local</span> Voice</span>\n    </a>\n    <div class="hr">\n      <div id="dot" title="API status"></div>\n      <button id="sb-btn" onclick="openSettings()" aria-label="Settings">&#9881;</button>\n    </div>\n  </header>\n\n  <div id="chat">\n    <div id="empty">\n      <div class="ei">&#127897;&#65039;</div>\n      <p>–ù–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –∏ –≥–æ–≤–æ—Ä–∏,<br/>–∏–ª–∏ –Ω–∞–ø–µ—á–∞—Ç–∞–π –≤–æ–ø—Ä–æ—Å.</p>\n      <small>GodLocal AI ¬∑ godlocal-api</small>\n    </div>\n  </div>\n\n  <div id="live"></div>\n\n  <div id="bot">\n    <div id="st">–Ω–∞–∂–º–∏ —á—Ç–æ–±—ã –≥–æ–≤–æ—Ä–∏—Ç—å</div>\n\n    <div id="orb" role="button" aria-label="Speak"></div>\n\n    <div id="tr">\n      <input id="ti" type="text" placeholder="–∏–ª–∏ –Ω–∞–ø–µ—á–∞—Ç–∞–π –∑–¥–µ—Å—å‚Ä¶" autocomplete="off" autocorrect="off" autocapitalize="off"/>\n      <button id="sb" onclick="sendText()">&#9658;</button>\n    </div>\n\n    <div id="acts">\n      <button class="act" id="mb" onclick="toggleMute()">&#128266; –∑–≤—É–∫</button>\n      <button class="act" onclick="clearChat()">&#128465; –æ—á–∏—Å—Ç–∏—Ç—å</button>\n    </div>\n  </div>\n\n  <div id="sp">\n    <div class="sph">\n      <span class="spt">&#9881; –ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>\n      <button id="spc" onclick="closeSettings()">&#215;</button>\n    </div>\n    <div class="sg">\n      <label>–ì–æ–ª–æ—Å TTS</label>\n      <select id="vs" onchange="saveCfg()"></select>\n    </div>\n    <div class="sg">\n      <label>–°–∫–æ—Ä–æ—Å—Ç—å —Ä–µ—á–∏</label>\n      <input type="range" id="rs" min="0.6" max="1.6" step="0.1" value="1.0" oninput="saveCfg()"/>\n    </div>\n    <div class="sg">\n      <label>–ü–µ—Ä—Å–æ–Ω–∞ (–¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∫ –∑–∞–ø—Ä–æ—Å—É)</label>\n      <select id="ps" onchange="saveCfg()">\n        <option value="">–ù–µ—Ç (–æ–±—ã—á–Ω—ã–π –∞–≥–µ–Ω—Ç)</option>\n        <option value="j">Jarvis ‚Äî —Ç–æ—á–Ω—ã–π –∏ –±—ã—Å—Ç—Ä—ã–π</option>\n        <option value="s">Sage ‚Äî –≤–¥—É–º—á–∏–≤—ã–π –∏ –≥–ª—É–±–æ–∫–∏–π</option>\n        <option value="w">WOLF ‚Äî –ø—Ä—è–º–æ–π, –±–µ–∑ –≤–æ–¥—ã</option>\n      </select>\n    </div>\n    <div class="sg">\n      <label>–Ø–∑—ã–∫ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è</label>\n      <select id="ls" onchange="saveCfg()">\n        <option value="ru-RU">–†—É—Å—Å–∫–∏–π</option>\n        <option value="en-US">English</option>\n      </select>\n    </div>\n    <p class="sn">–ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ –ø—Ä–∏—Ö–æ–¥–∏—Ç ‚Äî –Ω–∞–∂–º–∏ –∫–Ω–æ–ø–∫—É –µ—â—ë —Ä–∞–∑ –∏ –ø–æ–¥–æ–∂–¥–∏ (Render –º–æ–∂–µ—Ç —Å–ø–∞—Ç—å 15-30 —Å–µ–∫ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—Ä–æ—Å–µ).</p>\n  </div>\n</div>\n\n<script>\n(function(){\n\'use strict\';\n\nvar WS_URL=\'wss://godlocal-api.onrender.com/ws/chat\';\nvar REST_URL=\'https://godlocal-api.onrender.com/think\';\nvar PERSONA_PREFIXES={\n  j:\'[Respond as a precise concise AI. Max 3 sentences.] \',\n  s:\'[Respond thoughtfully and with depth.] \',\n  w:\'[WOLF mode: be blunt, direct, no fluff. Short.] \'\n};\nvar TIMEOUT_MS=20000; // 20s before fallback\n\nfunction ls(k){return localStorage.getItem(\'glv_\'+k)}\nfunction ss(k,v){localStorage.setItem(\'glv_\'+k,v)}\n\nvar cfg={\n  voice:ls(\'vn\')||\'\',\n  rate:parseFloat(ls(\'vr\')||\'1.0\'),\n  persona:ls(\'vp\')||\'\',\n  lang:ls(\'vl\')||\'ru-RU\',\n  muted:ls(\'vm\')===\'1\'\n};\n\n// STATE\nvar ws=null,wsOk=false;\nvar rec=null,recActive=false;\nvar synth=window.speechSynthesis;\nvar voices=[];\nvar thinkId=null;\nvar speaking=false;\nvar streamTimer=null;\nvar responseTimer=null; // timeout for no-response fallback\n\n// ELEMENTS\nvar $chat=document.getElementById(\'chat\');\nvar $empty=document.getElementById(\'empty\');\nvar $live=document.getElementById(\'live\');\nvar $st=document.getElementById(\'st\');\nvar $orb=document.getElementById(\'orb\');\nvar $dot=document.getElementById(\'dot\');\nvar $mb=document.getElementById(\'mb\');\nvar $ti=document.getElementById(\'ti\');\n\n// INIT\nfunction init(){\n  $orb.textContent=\'\';\n  $orb.innerHTML=\'<span id="oi">&#127908;</span>\';\n  document.getElementById(\'rs\').value=cfg.rate;\n  document.getElementById(\'ps\').value=cfg.persona;\n  document.getElementById(\'ls\').value=cfg.lang;\n  updateMuteBtn();\n  loadVoices();\n  connectWS();\n  $orb.addEventListener(\'click\',function(e){e.preventDefault();toggleListen();});\n  $ti.addEventListener(\'keydown\',function(e){\n    if(e.key===\'Enter\'&&!e.shiftKey){e.preventDefault();sendText();}\n  });\n}\n\n// ‚îÄ‚îÄ WS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nfunction connectWS(){\n  try{\n    if(ws){ws.onclose=null;try{ws.close();}catch(e){}}\n    setDot(\'\');\n    ws=new WebSocket(WS_URL);\n    ws.onopen=function(){wsOk=true;setDot(\'on\');};\n    ws.onerror=function(){wsOk=false;setDot(\'err\');};\n    ws.onclose=function(){wsOk=false;setDot(\'err\');setTimeout(connectWS,5000);};\n    ws.onmessage=handleToken;\n  }catch(ex){setDot(\'err\');}\n}\n\nfunction handleToken(e){\n  var tok=typeof e.data===\'string\'?e.data:\'\';\n  if(!tok)return;\n\n  // cancel response timeout ‚Äî we got at least one token\n  clearTimeout(responseTimer);\n\n  // remove thinking bubble on first token\n  if(thinkId){\n    var el=document.getElementById(thinkId);\n    if(el)el.remove();\n    thinkId=null;\n  }\n\n  // find or create streaming bubble\n  var bbl=document.getElementById(\'streaming\');\n  if(!bbl){bbl=addMsg(\'a\',\'\',{id:\'streaming\'});}\n  var txt=bbl.querySelector(\'.btxt\');\n  txt.textContent=(txt.textContent||\'\')+tok;\n  scrollBot();\n  setStatus(\'–ø–æ–ª—É—á–∞—é‚Ä¶\',\'tk\');\n\n  // end-of-stream: 800ms silence after last token\n  clearTimeout(streamTimer);\n  streamTimer=setTimeout(function(){\n    var el=document.getElementById(\'streaming\');\n    if(el){\n      var t=el.querySelector(\'.btxt\').textContent.trim();\n      el.removeAttribute(\'id\');\n      if(t){\n        setStatus(\'–Ω–∞–∂–º–∏ —á—Ç–æ–±—ã –≥–æ–≤–æ—Ä–∏—Ç—å\');\n        resetOrb();\n        speak(t);\n      }\n    }\n  },800);\n}\n\nfunction sendToAgent(text){\n  if(!text)return;\n  addMsg(\'u\',text);\n\n  // prepend persona prefix if set\n  var persona=cfg.persona;\n  var msg=persona&&PERSONA_PREFIXES[persona]?PERSONA_PREFIXES[persona]+text:text;\n\n  thinkId=\'tk\'+Date.now();\n  addThink(thinkId);\n  setStatus(\'–¥—É–º–∞—é‚Ä¶\',\'tk\');\n  $orb.className=\'tk\';\n  document.getElementById(\'oi\').textContent=\'üí≠\';\n\n  // start response timeout\n  responseTimer=setTimeout(function(){fallbackRest(msg,text);},TIMEOUT_MS);\n\n  // FIX: send ONLY {message, service_tokens} ‚Äî backend doesn\'t expect \'system\' field\n  var payload=JSON.stringify({message:msg,service_tokens:{}});\n\n  if(wsOk&&ws&&ws.readyState===1){\n    try{ws.send(payload);}\n    catch(ex){clearTimeout(responseTimer);fallbackRest(msg,text);}\n  }else{\n    clearTimeout(responseTimer);\n    fallbackRest(msg,text);\n  }\n}\n\n// REST fallback using /think endpoint (confirmed working, returns {response:"..."})\nfunction fallbackRest(msg,origText){\n  clearTimeout(responseTimer);\n  // remove thinking bubble if still showing\n  if(thinkId){var el=document.getElementById(thinkId);if(el)el.remove();thinkId=null;}\n\n  var fallbackThink=\'ftk\'+Date.now();\n  addThink(fallbackThink);\n  setStatus(\'—á–µ—Ä–µ–∑ HTTP‚Ä¶\',\'tk\');\n\n  fetch(REST_URL,{\n    method:\'POST\',\n    headers:{\'Content-Type\':\'application/json\'},\n    body:JSON.stringify({message:msg})\n  })\n  .then(function(r){\n    if(!r.ok)throw new Error(\'HTTP \'+r.status);\n    return r.json();\n  })\n  .then(function(d){\n    var el=document.getElementById(fallbackThink);if(el)el.remove();\n    var reply=d.response||d.message||d.text||JSON.stringify(d);\n    addMsg(\'a\',reply);\n    setStatus(\'–Ω–∞–∂–º–∏ —á—Ç–æ–±—ã –≥–æ–≤–æ—Ä–∏—Ç—å\');resetOrb();\n    speak(reply);\n  })\n  .catch(function(err){\n    var el=document.getElementById(fallbackThink);if(el)el.remove();\n    var errMsg=\'–ê–≥–µ–Ω—Ç –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª (\'+err.message+\'). –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑ ‚Äî —Å–µ—Ä–≤–µ—Ä –º–æ–≥ —Å–ø–∞—Ç—å.\';\n    addMsg(\'a\',errMsg,{cls:\'err\'});\n    setStatus(\'–æ—à–∏–±–∫–∞\',\'er\');$orb.className=\'er\';\n    document.getElementById(\'oi\').textContent=\'‚ö†Ô∏è\';\n    setTimeout(resetOrb,3000);\n  });\n}\n\n// ‚îÄ‚îÄ SPEECH RECOGNITION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nfunction toggleListen(){\n  if(speaking){synth.cancel();speaking=false;}\n  if(recActive){stopRec();}else{startRec();}\n}\n\nfunction startRec(){\n  var SR=window.SpeechRecognition||window.webkitSpeechRecognition;\n  if(!SR){\n    setStatus(\'–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è\',\'er\');\n    $ti.focus();return;\n  }\n  recActive=true;\n  $orb.className=\'ls\';\n  document.getElementById(\'oi\').textContent=\'üî¥\';\n  setStatus(\'—Å–ª—É—à–∞—é‚Ä¶\',\'ls\');\n\n  rec=new SR();\n  rec.continuous=false;rec.interimResults=true;rec.lang=cfg.lang;\n\n  rec.onresult=function(e){\n    var interim=\'\',final=\'\';\n    for(var i=e.resultIndex;i<e.results.length;i++){\n      if(e.results[i].isFinal)final+=e.results[i][0].transcript;\n      else interim+=e.results[i][0].transcript;\n    }\n    showLive(final||interim);\n    if(final){hideLive();stopRec(true);sendToAgent(final.trim());}\n  };\n\n  rec.onerror=function(e){\n    hideLive();recActive=false;\n    var msg=e.error===\'not-allowed\'?\'–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É\':\n            e.error===\'no-speech\'?\'–ù–µ —É—Å–ª—ã—à–∞–ª ‚Äî –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑\':\'–û—à–∏–±–∫–∞: \'+e.error;\n    setStatus(msg,\'er\');resetOrb();setTimeout(function(){setStatus(\'–Ω–∞–∂–º–∏ —á—Ç–æ–±—ã –≥–æ–≤–æ—Ä–∏—Ç—å\');},2500);\n  };\n\n  rec.onend=function(){if(recActive){recActive=false;resetOrb();}};\n\n  try{rec.start();}\n  catch(ex){recActive=false;setStatus(\'–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω\',\'er\');resetOrb();}\n}\n\nfunction stopRec(silent){\n  recActive=false;\n  if(rec){try{rec.stop();}catch(ex){} rec=null;}\n  if(!silent)resetOrb();\n}\n\n// ‚îÄ‚îÄ TTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nfunction loadVoices(){\n  function load(){\n    voices=synth.getVoices();\n    var sel=document.getElementById(\'vs\');\n    sel.innerHTML=\'<option value="">–ê–≤—Ç–æ</option>\';\n    voices.forEach(function(v){\n      var o=document.createElement(\'option\');\n      o.value=v.name;o.textContent=v.name+\' (\'+v.lang+\')\';\n      if(v.name===cfg.voice)o.selected=true;\n      sel.appendChild(o);\n    });\n  }\n  load();\n  if(synth.onvoiceschanged!==undefined)synth.onvoiceschanged=load;\n}\n\nfunction speak(text){\n  if(cfg.muted||!text)return;\n  setStatus(\'–≥–æ–≤–æ—Ä—é‚Ä¶\',\'sp\');$orb.className=\'sp\';document.getElementById(\'oi\').textContent=\'üîä\';\n  speaking=true;\n  var clean=text.replace(/[*_~#>\\x60]/g,\'\').replace(/https?:\\/\\/\\S+/g,\'\').trim();\n  var chunks=[];var sents=clean.match(/[^.!?]+[.!?]*/g)||[clean];var cur=\'\';\n  sents.forEach(function(s){\n    if((cur+s).length>160&&cur){chunks.push(cur.trim());cur=s;}else cur+=s;\n  });\n  if(cur.trim())chunks.push(cur.trim());\n  chunks=chunks.filter(Boolean);\n  var i=0;\n  function next(){\n    if(!speaking||i>=chunks.length){speaking=false;resetOrb();return;}\n    var u=new SpeechSynthesisUtterance(chunks[i++]);\n    u.rate=cfg.rate;u.pitch=1.0;\n    if(cfg.voice){var vx=voices.find(function(v){return v.name===cfg.voice;});if(vx)u.voice=vx;}\n    u.onend=next;u.onerror=next;\n    synth.speak(u);\n  }\n  next();\n}\n\n// ‚îÄ‚îÄ UI HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nfunction addMsg(role,text,opts){\n  if($empty)$empty.style.display=\'none\';\n  var wrap=document.createElement(\'div\');\n  wrap.className=\'msg \'+role+(opts&&opts.cls?\' \'+opts.cls:\'\');\n  if(opts&&opts.id)wrap.id=opts.id;\n  var bbl=document.createElement(\'div\');bbl.className=\'bbl\';\n  var span=document.createElement(\'span\');span.className=\'btxt\';span.textContent=text;\n  bbl.appendChild(span);\n  var ts=document.createElement(\'div\');ts.className=\'ts\';\n  ts.textContent=new Date().toLocaleTimeString([],{hour:\'2-digit\',minute:\'2-digit\'});\n  wrap.appendChild(bbl);wrap.appendChild(ts);\n  $chat.appendChild(wrap);scrollBot();return wrap;\n}\nfunction addThink(id){\n  var w=document.createElement(\'div\');w.className=\'msg a\';w.id=id;\n  w.innerHTML=\'<div class="bbl"><div class="dots"><span></span><span></span><span></span></div></div>\';\n  $chat.appendChild(w);scrollBot();\n}\nfunction scrollBot(){$chat.scrollTop=$chat.scrollHeight;}\nfunction setStatus(t,cls){$st.textContent=t;$st.className=cls||\'\';}\nfunction setDot(cls){$dot.className=cls;}\nfunction showLive(t){$live.textContent=t;$live.className=\'on\';}\nfunction hideLive(){$live.textContent=\'\';$live.className=\'\';}\nfunction resetOrb(){\n  if(!thinkId&&!speaking){\n    $orb.className=\'\';\n    var oi=document.getElementById(\'oi\');\n    if(oi)oi.textContent=\'üé§\';\n    setStatus(\'–Ω–∞–∂–º–∏ —á—Ç–æ–±—ã –≥–æ–≤–æ—Ä–∏—Ç—å\');\n  }\n}\n\n// ACTIONS\nwindow.sendText=function(){\n  var v=$ti.value.trim();if(!v)return;\n  $ti.value=\'\';\n  if(speaking){synth.cancel();speaking=false;}\n  sendToAgent(v);\n};\nwindow.toggleMute=function(){\n  cfg.muted=!cfg.muted;ss(\'vm\',cfg.muted?\'1\':\'0\');\n  if(cfg.muted){synth.cancel();speaking=false;resetOrb();}\n  updateMuteBtn();\n};\nfunction updateMuteBtn(){$mb.textContent=cfg.muted?\'üîá –±–µ–∑ –∑–≤—É–∫–∞\':\'üîä –∑–≤—É–∫\';}\nwindow.clearChat=function(){\n  clearTimeout(streamTimer);clearTimeout(responseTimer);\n  if(rec){try{rec.stop();}catch(e){}}recActive=false;\n  synth.cancel();speaking=false;\n  $chat.innerHTML=\'\';$chat.appendChild($empty);$empty.style.display=\'\';\n  setStatus(\'–Ω–∞–∂–º–∏ —á—Ç–æ–±—ã –≥–æ–≤–æ—Ä–∏—Ç—å\');resetOrb();\n};\nwindow.openSettings=function(){document.getElementById(\'sp\').classList.add(\'open\');};\nwindow.closeSettings=function(){document.getElementById(\'sp\').classList.remove(\'open\');};\nwindow.saveCfg=function(){\n  cfg.voice=document.getElementById(\'vs\').value;\n  cfg.rate=parseFloat(document.getElementById(\'rs\').value);\n  cfg.persona=document.getElementById(\'ps\').value;\n  cfg.lang=document.getElementById(\'ls\').value;\n  ss(\'vn\',cfg.voice);ss(\'vr\',cfg.rate);ss(\'vp\',cfg.persona);ss(\'vl\',cfg.lang);\n};\n\ndocument.body.addEventListener(\'touchmove\',function(e){\n  if(!e.target.closest(\'#chat\'))e.preventDefault();\n},{passive:false});\n\nwindow.addEventListener(\'load\',init);\n})();\n</script>\n</body>\n</html>';

export async function GET() {
  return new NextResponse(HTML, {
    headers: {
      'Content-Type': 'text/html; charset=utf-8',
      'Cache-Control': 'no-store, no-cache, must-revalidate',
    },
  });
}
