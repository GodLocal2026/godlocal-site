import { NextResponse } from 'next/server';

const HTML = '<!DOCTYPE html>\n<html lang="ru">\n<head>\n  <meta charset="UTF-8"/>\n  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>\n  <meta name="apple-mobile-web-app-capable" content="yes"/>\n  <meta name="theme-color" content="#0A0C0F"/>\n  <title>GodLocal Voice</title>\n  <style>\n    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}\n    :root{--bg:#0A0C0F;--s:#111316;--b:#1e2127;--g:#00FF9D;--p:#6C5CE7;--t:#E0E0E0;--m:rgba(224,224,224,.45);--d:rgba(224,224,224,.15)}\n    html,body{height:100%;background:var(--bg);color:var(--t);\n      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;\n      overflow:hidden;-webkit-tap-highlight-color:transparent}\n    #app{display:flex;flex-direction:column;height:100%}\n    header{display:flex;align-items:center;justify-content:space-between;\n      padding:12px 16px;border-bottom:1px solid var(--b);\n      background:rgba(10,12,15,.92);backdrop-filter:blur(12px);flex-shrink:0;z-index:10}\n    .logo{display:flex;align-items:center;gap:8px;text-decoration:none;color:var(--t)}\n    .li{width:26px;height:26px;border-radius:6px;background:rgba(0,255,157,.1);\n      border:1px solid rgba(0,255,157,.3);display:flex;align-items:center;justify-content:center;\n      font-family:monospace;font-weight:700;font-size:12px;color:var(--g)}\n    .lt{font-weight:700;font-size:15px}.lt span{color:var(--g)}\n    .hr{display:flex;align-items:center;gap:10px}\n    #dot{width:7px;height:7px;border-radius:50%;background:#444;transition:all .3s}\n    #dot.on{background:var(--g);box-shadow:0 0 6px rgba(0,255,157,.7)}\n    #dot.err{background:#FF6B6B}\n    #dot.warm{background:#F0A500;animation:blink .8s ease-in-out infinite}\n    @keyframes blink{0%,100%{opacity:.4}50%{opacity:1}}\n    #sb-btn{background:none;border:none;cursor:pointer;color:var(--m);font-size:17px;padding:4px 6px;line-height:1}\n    #chat{flex:1;overflow-y:auto;padding:12px 14px 4px;display:flex;flex-direction:column;gap:8px}\n    #chat::-webkit-scrollbar{width:2px}\n    #chat::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08)}\n    .msg{display:flex;flex-direction:column;max-width:86%;animation:fu .22s ease}\n    @keyframes fu{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}\n    .msg.u{align-self:flex-end;align-items:flex-end}\n    .msg.a{align-self:flex-start;align-items:flex-start}\n    .bbl{padding:9px 13px;border-radius:15px;font-size:14px;line-height:1.6;word-break:break-word}\n    .msg.u .bbl{background:rgba(0,255,157,.1);border:1px solid rgba(0,255,157,.2);border-bottom-right-radius:3px}\n    .msg.a .bbl{background:var(--s);border:1px solid var(--b);border-bottom-left-radius:3px}\n    .msg.err .bbl{background:rgba(255,107,107,.08);border:1px solid rgba(255,107,107,.25);color:#FF8A8A}\n    .bbl a{color:var(--g);text-decoration:underline;text-underline-offset:2px}\n    .bbl a:active{opacity:.7}\n    .bbl strong{color:var(--t);font-weight:600}\n    .bbl code{font-family:monospace;font-size:12px;background:rgba(255,255,255,.07);padding:1px 5px;border-radius:4px}\n    .ts{font-size:10px;color:var(--d);margin-top:2px;padding:0 3px;font-family:monospace}\n    .dots{display:inline-flex;gap:4px}\n    .dots span{width:6px;height:6px;border-radius:50%;background:var(--g);opacity:.3;animation:bk 1.2s infinite}\n    .dots span:nth-child(2){animation-delay:.2s}.dots span:nth-child(3){animation-delay:.4s}\n    @keyframes bk{0%,80%,100%{opacity:.2;transform:scale(.9)}40%{opacity:1;transform:scale(1.1)}}\n    #empty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;\n      gap:6px;text-align:center}\n    #empty .ei{font-size:42px;opacity:.3;margin-bottom:4px}\n    #empty p{font-size:13px;line-height:1.65;max-width:190px;color:var(--m)}\n    #empty small{font-size:11px;font-family:monospace;color:var(--d)}\n    #live{flex-shrink:0;padding:3px 18px;min-height:22px;font-size:12px;font-style:italic;\n      color:var(--m);opacity:0;transition:opacity .2s}\n    #live.on{opacity:1}\n    #bot{flex-shrink:0;padding:10px 14px 22px;border-top:1px solid var(--b);\n      background:linear-gradient(to top,rgba(0,255,157,.03),transparent);\n      display:flex;flex-direction:column;align-items:center;gap:10px}\n    #st{font-size:12px;font-family:monospace;color:var(--m);height:15px;transition:color .2s;text-align:center}\n    #st.ls{color:var(--g)}#st.tk{color:var(--p)}#st.sp{color:#00B4D8}#st.er{color:#FF8A8A}#st.wm{color:#F0A500}\n    #orb{width:66px;height:66px;border-radius:50%;background:var(--s);\n      border:2px solid rgba(0,255,157,.2);display:flex;align-items:center;justify-content:center;\n      cursor:pointer;transition:all .15s;-webkit-user-select:none;user-select:none;\n      touch-action:manipulation;-webkit-tap-highlight-color:rgba(0,255,157,.15);outline:none}\n    #orb:active{transform:scale(.92);background:rgba(0,255,157,.12);border-color:var(--g)}\n    #orb.ls{background:rgba(0,255,157,.1);border-color:var(--g);animation:pulse 1.4s ease-in-out infinite}\n    #orb.tk{background:rgba(108,92,231,.1);border-color:var(--p)}\n    #orb.sp{background:rgba(0,180,216,.1);border-color:#00B4D8}\n    #orb.er{background:rgba(255,107,107,.1);border-color:#FF6B6B}\n    #orb.wm{background:rgba(240,165,0,.08);border-color:#F0A500;animation:pulse2 1.6s ease-in-out infinite}\n    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(0,255,157,.4)}70%{box-shadow:0 0 0 16px rgba(0,255,157,0)}100%{box-shadow:0 0 0 0 rgba(0,255,157,0)}}\n    @keyframes pulse2{0%{box-shadow:0 0 0 0 rgba(240,165,0,.3)}70%{box-shadow:0 0 0 14px rgba(240,165,0,0)}100%{box-shadow:0 0 0 0 rgba(240,165,0,0)}}\n    #oi{font-size:26px;pointer-events:none;line-height:1}\n    #tr{display:flex;gap:8px;width:100%;max-width:480px}\n    #ti{flex:1;background:var(--s);border:1px solid var(--b);border-radius:20px;\n      color:var(--t);padding:9px 14px;font-size:14px;outline:none;min-width:0}\n    #ti::placeholder{color:var(--d)}\n    #ti:focus{border-color:rgba(0,255,157,.35)}\n    #sb{background:rgba(0,255,157,.1);border:1px solid rgba(0,255,157,.25);border-radius:20px;\n      color:var(--g);padding:9px 14px;font-size:13px;cursor:pointer;\n      transition:background .15s;touch-action:manipulation;white-space:nowrap}\n    #sb:active{background:rgba(0,255,157,.2)}\n    #acts{display:flex;gap:8px}\n    .act{padding:5px 11px;border-radius:16px;font-size:12px;\n      border:1px solid var(--b);background:none;color:var(--m);cursor:pointer;\n      transition:all .15s;touch-action:manipulation}\n    .act:active{color:var(--t);border-color:rgba(255,255,255,.2)}\n    #sp{position:absolute;inset:0;background:rgba(10,12,15,.97);backdrop-filter:blur(14px);\n      z-index:20;display:flex;flex-direction:column;padding:22px 18px;gap:18px;\n      transform:translateX(100%);transition:transform .26s cubic-bezier(.4,0,.2,1)}\n    #sp.open{transform:translateX(0)}\n    .sph{display:flex;align-items:center;justify-content:space-between}\n    .spt{font-weight:700;font-size:16px}\n    #spc{background:none;border:none;cursor:pointer;color:var(--m);font-size:22px}\n    .sg label{display:block;font-size:11px;font-family:monospace;color:var(--m);\n      text-transform:uppercase;letter-spacing:.08em;margin-bottom:7px}\n    .sg select,.sg input{width:100%;background:var(--s);border:1px solid var(--b);\n      border-radius:10px;color:var(--t);padding:9px 12px;font-size:13px;outline:none;\n      -webkit-appearance:none;appearance:none}\n    .sg select:focus,.sg input[type="text"]:focus{border-color:rgba(0,255,157,.4)}\n    .sn{font-size:12px;color:var(--d);line-height:1.5}\n  </style>\n</head>\n<body>\n<div id="app">\n  <header>\n    <a class="logo" href="/">\n      <div class="li">G</div>\n      <span class="lt">God<span>Local</span> Voice</span>\n    </a>\n    <div class="hr">\n      <div id="dot" title="API status"></div>\n      <button id="sb-btn" onclick="openSettings()" aria-label="Settings">&#9881;</button>\n    </div>\n  </header>\n  <div id="chat">\n    <div id="empty">\n      <div class="ei">ğŸ™ï¸</div>\n      <p>ĞĞ°Ğ¶Ğ¼Ğ¸ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ Ğ¸ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸,<br/>Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ°Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ.</p>\n      <small>GodLocal AI Â· godlocal-api</small>\n    </div>\n  </div>\n  <div id="live"></div>\n  <div id="bot">\n    <div id="st">Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµâ€¦</div>\n    <div id="orb" role="button" aria-label="Speak"><span id="oi">â³</span></div>\n    <div id="tr">\n      <input id="ti" type="text" placeholder="Ğ¸Ğ»Ğ¸ Ğ½Ğ°Ğ¿ĞµÑ‡Ğ°Ñ‚Ğ°Ğ¹ Ğ·Ğ´ĞµÑÑŒâ€¦" autocomplete="off" autocorrect="off" autocapitalize="off"/>\n      <button id="sb" onclick="sendText()">&#9658;</button>\n    </div>\n    <div id="acts">\n      <button class="act" id="mb" onclick="toggleMute()">ğŸ”Š Ğ·Ğ²ÑƒĞº</button>\n      <button class="act" onclick="clearChat()">ğŸ—‘ Ğ¾Ñ‡Ğ¸ÑÑ‚Ğ¸Ñ‚ÑŒ</button>\n    </div>\n  </div>\n  <div id="sp">\n    <div class="sph">\n      <span class="spt">âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</span>\n      <button id="spc" onclick="closeSettings()">&#215;</button>\n    </div>\n    <div class="sg">\n      <label>Ğ“Ğ¾Ğ»Ğ¾Ñ TTS</label>\n      <select id="vs" onchange="saveCfg()"></select>\n    </div>\n    <div class="sg">\n      <label>Ğ¡ĞºĞ¾Ñ€Ğ¾ÑÑ‚ÑŒ Ñ€ĞµÑ‡Ğ¸</label>\n      <input type="range" id="rs" min="0.6" max="1.6" step="0.1" value="1.0" oninput="saveCfg()"/>\n    </div>\n    <div class="sg">\n      <label>ĞŸĞµÑ€ÑĞ¾Ğ½Ğ°</label>\n      <select id="ps" onchange="saveCfg()">\n        <option value="">ĞĞµÑ‚ (ÑƒĞ¼Ğ½Ñ‹Ğ¹ Ğ°Ğ³ĞµĞ½Ñ‚)</option>\n        <option value="j">Jarvis â€” Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ğ¸ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹</option>\n        <option value="s">Sage â€” Ğ²Ğ´ÑƒĞ¼Ñ‡Ğ¸Ğ²Ñ‹Ğ¹ Ğ¸ Ğ³Ğ»ÑƒĞ±Ğ¾ĞºĞ¸Ğ¹</option>\n        <option value="w">WOLF â€” Ğ¿Ñ€ÑĞ¼Ğ¾Ğ¹, Ğ±ĞµĞ· Ğ²Ğ¾Ğ´Ñ‹</option>\n      </select>\n    </div>\n    <div class="sg">\n      <label>Ğ¯Ğ·Ñ‹Ğº Ñ€Ğ°ÑĞ¿Ğ¾Ğ·Ğ½Ğ°Ğ²Ğ°Ğ½Ğ¸Ñ</label>\n      <select id="ls" onchange="saveCfg()">\n        <option value="ru-RU">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>\n        <option value="en-US">English</option>\n      </select>\n    </div>\n    <p class="sn">ĞÑ€Ğ°Ğ½Ğ¶ĞµĞ²Ğ°Ñ Ñ‚Ğ¾Ñ‡ĞºĞ° â€” ÑĞµÑ€Ğ²ĞµÑ€ Ğ¿Ñ€Ğ¾ÑÑ‹Ğ¿Ğ°ĞµÑ‚ÑÑ (15-30 ÑĞµĞº Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ). Ğ—ĞµĞ»Ñ‘Ğ½Ğ°Ñ â€” Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾.</p>\n  </div>\n</div>\n<script>\n(function(){\n\'use strict\';\n\nvar API=\'https://godlocal-api.onrender.com\';\nvar WS_URL=\'wss://godlocal-api.onrender.com/ws/chat\';\nvar TIMEOUT_MS=20000;\nvar PERSONA={\n  j:\'[Answer as Jarvis: precise, concise, max 3 sentences.] \',\n  s:\'[Answer as Sage: thoughtful and detailed.] \',\n  w:\'[Answer as WOLF: blunt, direct, zero fluff.] \'\n};\nvar CHAT_RE=/^(Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚|Ğ·Ğ´Ñ€Ğ°Ğ²ÑÑ‚Ğ²ÑƒĞ¹|Ñ…Ğ°Ğ¹|ĞºĞ°Ğº Ğ´ĞµĞ»Ğ°|ĞºĞ°Ğº Ñ‚Ñ‹|ĞºĞ°Ğº Ğ¶Ğ¸Ğ·Ğ½ÑŒ|hello|hi |hey |how are|Ñ‡Ñ‘ |Ñ‡Ñ‚Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾|Ğ´Ğ¾Ğ±Ñ€Ñ‹Ğ¹|ÑĞ¿Ğ°ÑĞ¸Ğ±Ğ¾|thanks|Ğ¿Ğ¾ĞºĞ°|bye |Ğ¾Ğº |Ñ…Ğ¾Ñ€Ğ¾ÑˆĞ¾|Ğ¿Ğ¾Ğ½ÑĞ»|super|Ğ¾ĞºĞµĞ¹|Ğ½Ğ¾Ñ€Ğ¼ )/i;\n\nfunction lsGet(k){return localStorage.getItem(\'glv_\'+k);}\nfunction lsSet(k,v){localStorage.setItem(\'glv_\'+k,v);}\nvar cfg={voice:lsGet(\'vn\')||\'\',rate:parseFloat(lsGet(\'vr\')||\'1.0\'),persona:lsGet(\'vp\')||\'\',lang:lsGet(\'vl\')||\'ru-RU\',muted:lsGet(\'vm\')===\'1\'};\n\nvar ws=null,wsOk=false;\nvar rec=null,recActive=false;\nvar synth=window.speechSynthesis;\nvar voices=[];\nvar ttsUnlocked=false;\nvar thinkId=null,speaking=false,streamTimer=null,responseTimer=null;\n\nvar $chat=document.getElementById(\'chat\');\nvar $empty=document.getElementById(\'empty\');\nvar $live=document.getElementById(\'live\');\nvar $st=document.getElementById(\'st\');\nvar $orb=document.getElementById(\'orb\');\nvar $oi=document.getElementById(\'oi\');\nvar $dot=document.getElementById(\'dot\');\nvar $mb=document.getElementById(\'mb\');\nvar $ti=document.getElementById(\'ti\');\n\nfunction init(){\n  document.getElementById(\'rs\').value=cfg.rate;\n  document.getElementById(\'ps\').value=cfg.persona;\n  document.getElementById(\'ls\').value=cfg.lang;\n  updateMuteBtn();\n  loadVoices();\n  warmUp(connectWS);\n  $orb.addEventListener(\'click\',function(e){\n    e.preventDefault();\n    unlockTTS();\n    toggleListen();\n  });\n  $ti.addEventListener(\'keydown\',function(e){\n    if(e.key===\'Enter\'&&!e.shiftKey){e.preventDefault();unlockTTS();sendText();}\n  });\n  document.getElementById(\'sb\').addEventListener(\'click\',function(){unlockTTS();});\n}\n\n// â”€â”€ iOS TTS UNLOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction unlockTTS(){\n  if(ttsUnlocked||!synth)return;\n  ttsUnlocked=true;\n  var u=new SpeechSynthesisUtterance(\' \');\n  u.volume=0;u.rate=1;\n  synth.speak(u);\n  setTimeout(function(){try{synth.cancel();}catch(e){}},200);\n}\n\n// â”€â”€ TEXT RENDERING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n// Safely converts plain text to HTML with clickable links & markdown\nfunction renderMsg(raw){\n  // 1. Escape HTML special chars\n  var t=raw\n    .replace(/&/g,\'&amp;\')\n    .replace(/</g,\'&lt;\')\n    .replace(/>/g,\'&gt;\');\n  // 2. Markdown links: [label](url)  -- safe regex, no complex char classes\n  t=t.replace(/\\[([^\\]]+)\\]\\((https?:\\/\\/[^\\s)]+)\\)/g,\n    \'<a href="$2" target="_blank" rel="noopener">$1 &#8599;</a>\');\n  // 3. Bare URLs: https://... or http://...\n  // Use simple \\S+ to match non-whitespace after protocol\n  t=t.replace(/(^|\\s)(https?:\\/\\/\\S+)/g,\n    \'$1<a href="$2" target="_blank" rel="noopener">$2 &#8599;</a>\');\n  // 4. Bold: **text**\n  t=t.replace(/\\*\\*([^*\\n]+)\\*\\*/g,\'<strong>$1</strong>\');\n  // 5. Inline code: `text`\n  t=t.replace(/`([^`\\n]+)`/g,\'<code>$1</code>\');\n  // 6. Line breaks\n  t=t.replace(/\\n/g,\'<br>\');\n  return t;\n}\n\n// â”€â”€ WARM-UP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction warmUp(cb){\n  setDot(\'warm\');setStatus(\'ÑĞµÑ€Ğ²ĞµÑ€ Ğ¿Ñ€Ğ¾ÑÑ‹Ğ¿Ğ°ĞµÑ‚ÑÑâ€¦\',\'wm\');\n  $orb.className=\'wm\';$oi.textContent=\'â³\';\n  fetch(API+\'/api/health\',{cache:\'no-store\'})\n    .then(function(){cb();})\n    .catch(function(){cb();});\n}\n\n// â”€â”€ WEBSOCKET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction connectWS(){\n  try{\n    if(ws){ws.onclose=null;try{ws.close();}catch(e){}}\n    setDot(\'\');\n    ws=new WebSocket(WS_URL);\n    ws.onopen=function(){\n      wsOk=true;setDot(\'on\');\n      $orb.className=\'\';$oi.textContent=\'ğŸ¤\';\n      setStatus(\'Ğ½Ğ°Ğ¶Ğ¼Ğ¸ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒ\');\n    };\n    ws.onerror=function(){wsOk=false;setDot(\'err\');};\n    ws.onclose=function(){wsOk=false;setDot(\'err\');setTimeout(connectWS,5000);};\n    ws.onmessage=handleToken;\n  }catch(ex){setDot(\'err\');}\n}\n\nfunction handleToken(e){\n  var tok=typeof e.data===\'string\'?e.data:\'\';\n  if(!tok)return;\n  clearTimeout(responseTimer);\n  if(thinkId){var el=document.getElementById(thinkId);if(el)el.remove();thinkId=null;}\n  var wrap=document.getElementById(\'streaming\');\n  if(!wrap){wrap=addMsg(\'a\',\'\',{id:\'streaming\'});}\n  var span=wrap.querySelector(\'.btxt\');\n  span._raw=(span._raw||\'\')+tok;\n  span.innerHTML=renderMsg(span._raw);\n  scrollBot();\n  setStatus(\'Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°Ñâ€¦\',\'tk\');\n  clearTimeout(streamTimer);\n  streamTimer=setTimeout(function(){\n    var el=document.getElementById(\'streaming\');\n    if(el){\n      var t=el.querySelector(\'.btxt\')._raw||\'\';\n      el.removeAttribute(\'id\');\n      if(t){setStatus(\'Ğ½Ğ°Ğ¶Ğ¼Ğ¸ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒ\');resetOrb();speak(t);}\n    }\n  },800);\n}\n\n// â”€â”€ SMART MESSAGE BUILD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction buildMsg(userText){\n  var persona=cfg.persona&&PERSONA[cfg.persona]?PERSONA[cfg.persona]:\'\';\n  var isChat=CHAT_RE.test(userText.trim())&&userText.trim().length<60;\n  var prefix=isChat\n    ?\'Just respond conversationally (no tools needed): \'\n    :\'[Voice AI assistant. Solve the task using your tools (web_search, get_market_data, fetch_url, etc.) when needed. Give a clear direct answer. Language: match the user.] \';\n  return prefix+persona+userText;\n}\n\nfunction sendToAgent(text){\n  if(!text)return;\n  addMsg(\'u\',text);\n  var msg=buildMsg(text);\n  thinkId=\'tk\'+Date.now();addThink(thinkId);\n  setStatus(\'Ğ´ÑƒĞ¼Ğ°Ñâ€¦\',\'tk\');$orb.className=\'tk\';$oi.textContent=\'ğŸ’¬\';\n  responseTimer=setTimeout(function(){fallbackRest(msg);},TIMEOUT_MS);\n  var payload=JSON.stringify({message:msg,service_tokens:{}});\n  if(wsOk&&ws&&ws.readyState===1){\n    try{ws.send(payload);}catch(ex){clearTimeout(responseTimer);fallbackRest(msg);}\n  }else{clearTimeout(responseTimer);fallbackRest(msg);}\n}\n\n// â”€â”€ REST FALLBACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction fallbackRest(msg){\n  clearTimeout(responseTimer);\n  if(thinkId){var el=document.getElementById(thinkId);if(el)el.remove();thinkId=null;}\n  var ftk=\'ftk\'+Date.now();addThink(ftk);setStatus(\'Ñ‡ĞµÑ€ĞµĞ· HTTPâ€¦\',\'tk\');\n  fetch(API+\'/think\',{\n    method:\'POST\',headers:{\'Content-Type\':\'application/json\'},\n    body:JSON.stringify({message:msg})\n  })\n  .then(function(r){if(!r.ok)throw new Error(\'HTTP \'+r.status);return r.json();})\n  .then(function(d){\n    var el=document.getElementById(ftk);if(el)el.remove();\n    var reply=d.response||d.message||d.text||\'\';\n    if(!reply)throw new Error(\'empty\');\n    addMsg(\'a\',reply);setStatus(\'Ğ½Ğ°Ğ¶Ğ¼Ğ¸ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒ\');resetOrb();speak(reply);\n  })\n  .catch(function(err){\n    var el=document.getElementById(ftk);if(el)el.remove();\n    addMsg(\'a\',\'ĞĞµÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° (\'+err.message+\'). Render Ğ¼Ğ¾Ğ³ ÑĞ¿Ğ°Ñ‚ÑŒ â€” Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ·.\',{cls:\'err\'});\n    setStatus(\'Ğ¾ÑˆĞ¸Ğ±ĞºĞ°\',\'er\');$orb.className=\'er\';$oi.textContent=\'âš ï¸\';\n    setTimeout(resetOrb,3000);\n  });\n}\n\n// â”€â”€ SPEECH RECOGNITION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction toggleListen(){\n  if(speaking){synth.cancel();speaking=false;}\n  if(recActive){stopRec();}else{startRec();}\n}\nfunction startRec(){\n  var SR=window.SpeechRecognition||window.webkitSpeechRecognition;\n  if(!SR){setStatus(\'ĞœĞ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ÑÑ\',\'er\');$ti.focus();return;}\n  recActive=true;$orb.className=\'ls\';$oi.textContent=\'ğŸ”´\';setStatus(\'ÑĞ»ÑƒÑˆĞ°Ñâ€¦\',\'ls\');\n  rec=new SR();rec.continuous=false;rec.interimResults=true;rec.lang=cfg.lang;\n  rec.onresult=function(e){\n    var interim=\'\',final=\'\';\n    for(var i=e.resultIndex;i<e.results.length;i++){\n      if(e.results[i].isFinal)final+=e.results[i][0].transcript;\n      else interim+=e.results[i][0].transcript;\n    }\n    showLive(final||interim);\n    if(final){hideLive();stopRec(true);sendToAgent(final.trim());}\n  };\n  rec.onerror=function(e){\n    hideLive();recActive=false;\n    var msg=e.error===\'not-allowed\'?\'ĞĞµÑ‚ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½Ñƒ\':\n             e.error===\'no-speech\'?\'ĞĞµ ÑƒÑĞ»Ñ‹ÑˆĞ°Ğ» â€” Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹\':\'ĞÑˆĞ¸Ğ±ĞºĞ°: \'+e.error;\n    setStatus(msg,\'er\');resetOrb();setTimeout(function(){setStatus(\'Ğ½Ğ°Ğ¶Ğ¼Ğ¸ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒ\');},2500);\n  };\n  rec.onend=function(){if(recActive){recActive=false;resetOrb();}};\n  try{rec.start();}catch(ex){recActive=false;setStatus(\'ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½\',\'er\');resetOrb();}\n}\nfunction stopRec(silent){recActive=false;if(rec){try{rec.stop();}catch(ex){}rec=null;}if(!silent)resetOrb();}\n\n// â”€â”€ TTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction loadVoices(){\n  function load(){\n    voices=synth.getVoices();\n    var sel=document.getElementById(\'vs\');\n    sel.innerHTML=\'<option value="">ĞĞ²Ñ‚Ğ¾</option>\';\n    voices.forEach(function(v){\n      var o=document.createElement(\'option\');\n      o.value=v.name;\n      o.textContent=v.name+\' (\'+v.lang+\')\';\n      if(v.name===cfg.voice)o.selected=true;\n      sel.appendChild(o);\n    });\n  }\n  load();\n  if(synth.onvoiceschanged!==undefined)synth.onvoiceschanged=load;\n}\n\nfunction speak(text){\n  if(cfg.muted||!text)return;\n  setStatus(\'Ğ³Ğ¾Ğ²Ğ¾Ñ€Ñâ€¦\',\'sp\');$orb.className=\'sp\';$oi.textContent=\'ğŸ”Š\';speaking=true;\n  synth.cancel();\n  // Strip markdown for clean TTS audio\n  var clean=text\n    .replace(/\\[([^\\]]+)\\]\\([^)]+\\)/g,\'$1\')\n    .replace(/https?:\\/\\/\\S+/g,\'\')\n    .replace(/[*_~#>`]/g,\'\')\n    .replace(/\\s+/g,\' \')\n    .trim();\n  var chunks=[];\n  var sents=clean.match(/[^.!?]+[.!?]*/g)||[clean];\n  var cur=\'\';\n  sents.forEach(function(s){\n    if((cur+s).length>160&&cur){chunks.push(cur.trim());cur=s;}else cur+=s;\n  });\n  if(cur.trim())chunks.push(cur.trim());\n  chunks=chunks.filter(Boolean);\n  var i=0;\n  function next(){\n    if(!speaking||i>=chunks.length){speaking=false;resetOrb();return;}\n    var u=new SpeechSynthesisUtterance(chunks[i++]);\n    u.rate=cfg.rate;u.pitch=1.0;\n    if(cfg.voice){var vx=voices.find(function(v){return v.name===cfg.voice;});if(vx)u.voice=vx;}\n    u.onend=next;u.onerror=next;\n    synth.speak(u);\n  }\n  next();\n}\n\n// â”€â”€ UI HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\nfunction addMsg(role,text,opts){\n  if($empty)$empty.style.display=\'none\';\n  var wrap=document.createElement(\'div\');\n  wrap.className=\'msg \'+role+(opts&&opts.cls?\' \'+opts.cls:\'\');\n  if(opts&&opts.id)wrap.id=opts.id;\n  var bbl=document.createElement(\'div\');bbl.className=\'bbl\';\n  var span=document.createElement(\'span\');span.className=\'btxt\';\n  if(text){span._raw=text;span.innerHTML=renderMsg(text);}\n  bbl.appendChild(span);\n  var ts=document.createElement(\'div\');ts.className=\'ts\';\n  ts.textContent=new Date().toLocaleTimeString([],{hour:\'2-digit\',minute:\'2-digit\'});\n  wrap.appendChild(bbl);wrap.appendChild(ts);\n  $chat.appendChild(wrap);scrollBot();return wrap;\n}\nfunction addThink(id){\n  var w=document.createElement(\'div\');w.className=\'msg a\';w.id=id;\n  w.innerHTML=\'<div class="bbl"><div class="dots"><span></span><span></span><span></span></div></div>\';\n  $chat.appendChild(w);scrollBot();\n}\nfunction scrollBot(){$chat.scrollTop=$chat.scrollHeight;}\nfunction setStatus(t,cls){$st.textContent=t;$st.className=cls||\'\';}\nfunction setDot(cls){$dot.className=cls;}\nfunction showLive(t){$live.textContent=t;$live.className=\'on\';}\nfunction hideLive(){$live.textContent=\'\';$live.className=\'\';}\nfunction resetOrb(){\n  if(!thinkId&&!speaking){\n    $orb.className=\'\';$oi.textContent=\'ğŸ¤\';\n    setStatus(\'Ğ½Ğ°Ğ¶Ğ¼Ğ¸ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒ\');\n  }\n}\nwindow.sendText=function(){\n  var v=$ti.value.trim();if(!v)return;$ti.value=\'\';\n  if(speaking){synth.cancel();speaking=false;}\n  sendToAgent(v);\n};\nwindow.toggleMute=function(){\n  cfg.muted=!cfg.muted;lsSet(\'vm\',cfg.muted?\'1\':\'0\');\n  if(cfg.muted){synth.cancel();speaking=false;resetOrb();}\n  updateMuteBtn();\n};\nfunction updateMuteBtn(){\n  $mb.textContent=cfg.muted?\'ğŸ”‡ Ğ±ĞµĞ· Ğ·Ğ²ÑƒĞºĞ°\':\'ğŸ”Š Ğ·Ğ²ÑƒĞº\';\n}\nwindow.clearChat=function(){\n  clearTimeout(streamTimer);clearTimeout(responseTimer);\n  if(rec){try{rec.stop();}catch(e){}}recActive=false;\n  synth.cancel();speaking=false;\n  $chat.innerHTML=\'\';$chat.appendChild($empty);$empty.style.display=\'\';\n  setStatus(\'Ğ½Ğ°Ğ¶Ğ¼Ğ¸ Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸Ñ‚ÑŒ\');resetOrb();\n};\nwindow.openSettings=function(){document.getElementById(\'sp\').classList.add(\'open\');};\nwindow.closeSettings=function(){document.getElementById(\'sp\').classList.remove(\'open\');};\nwindow.saveCfg=function(){\n  cfg.voice=document.getElementById(\'vs\').value;\n  cfg.rate=parseFloat(document.getElementById(\'rs\').value);\n  cfg.persona=document.getElementById(\'ps\').value;\n  cfg.lang=document.getElementById(\'ls\').value;\n  lsSet(\'vn\',cfg.voice);lsSet(\'vr\',cfg.rate);lsSet(\'vp\',cfg.persona);lsSet(\'vl\',cfg.lang);\n};\ndocument.body.addEventListener(\'touchmove\',function(e){\n  if(!e.target.closest(\'#chat\'))e.preventDefault();\n},{passive:false});\nwindow.addEventListener(\'load\',init);\n})();\n</script>\n</body>\n</html>';

export async function GET() {
  return new NextResponse(HTML, {
    headers: {
      'Content-Type': 'text/html; charset=utf-8',
      'Cache-Control': 'no-store, no-cache, must-revalidate',
    },
  });
}
